---
import Logo from "@components/Logo.astro";
import menu from "@config/menu.json";

import LanguageSelector from "../Header/LanguageSelector.astro"
import { getRelativeLocaleUrl } from "astro:i18n";
import { getLangFromUrl, useTranslations } from '@i18n/utils';
import ChevronIcon from "./Chevron.astro"
import ThemeToggle from "./ThemeToggle.astro";

export interface ChildNavigationLink {
  name: string;
  url: string;
}

export interface NavigationLink {
  name: string;
  url: string;
  hasChildren?: boolean;
  children?: ChildNavigationLink[];
}

const { main }: { main: NavigationLink[] } = menu;
const { pathname } = Astro.url;

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const { currentLocale } = Astro

// console.log('Astro.props.is404')
// console.log(Astro.props.is404)

function isActive(pathname: string, baseUrl: string, locale: string) {
  const cleanPath = pathname.replace(/\/$/, '');
  const expectedBase = `/${locale}${baseUrl === '/' ? '' : baseUrl}`;

  // Si es la home
  if (baseUrl === '/') {
    return cleanPath === `/${locale}`;
  }

  // Si es otra sección
  return cleanPath.startsWith(expectedBase);
}
---

<header  class="header">
  <nav
  class="navbar container rounded-md lg:rounded-full border-transparent transition-all duration-[600ms] ease-[cubic-bezier(0.4,0,0.2,1)]"
>
  <!-- LOGO -->
  <div
    class="order-0 transition-transform duration-[600ms] ease-[cubic-bezier(0.4,0,0.2,1)] logo-container"
  >
    <Logo />
  </div>
    <!-- navbar toggler -->
    <input id="nav-toggle" type="checkbox" class="hidden" />
    <label
      id="show-button"
      for="nav-toggle"
      class="order-2 flex cursor-pointer items-center lg:order-1 lg:hidden dark:text-black"
    >
      <svg class="h-6 fill-current" viewBox="0 0 20 20">
        <title>Menu Open</title>
        <path d="M0 3h20v2H0V3z m0 6h20v2H0V9z m0 6h20v2H0V0z"></path>
      </svg>
    </label>
    <label
      id="hide-button"
      for="nav-toggle"
      class="order-2 hidden cursor-pointer items-center lg:order-1 dark:text-black"
    >
      <svg class="h-6 fill-current" viewBox="0 0 20 20">
        <title>Menu Close</title>
        <polygon
          points="11 9 22 9 22 11 11 11 11 22 9 22 9 11 -2 11 -2 9 9 9 9 -2 11 -2"
          transform="rotate(45 10 10)"></polygon>
      </svg>
    </label>
    <!-- /navbar toggler -->

    <ul   
      id="nav-menu"
      class="navbar-nav order-3 hidden w-full lg:order-1 lg:flex lg:w-auto lg:space-x-2"
    >
      {
        main.map((menu) => (
          <>
            {menu.hasChildren ? (
              //Nav con hijos (Products/)
              <li
                class="nav-item nav-dropdown group relative cursor-pointer gap-0"
                id="dropdown-button"
              >
                <a
                  href={getRelativeLocaleUrl(currentLocale ?? '', menu.url)}
                  class={`nav-link inline-block lg:block mx-4 ${
                    isActive(pathname, menu.url, currentLocale) ? "active" : ""
                  }`}
                >
                  {t(`nav.${menu.name.toLowerCase()}`)}
                </a>
                <div class={`nav-link peer-hover:text-primary hover:text-primary inline-flex items-center align-middle px-0 lg:absolute inset-y-0 lg:-right-1`}
                >
                  <ChevronIcon />
                </div>

                {/* Dropdown cambio de posicion (nav-dropdown-list) tamaño, color de fondo, etc*/}
                <ul
                  id="dropdown"
                  class=" border-2 border-primary lg:p-8  nav-dropdown-list hidden duration-400  lg:invisible lg:absolute lg:-left-[18rem] lg:top-12           lg:h-[300px] lg:w-[666px] mx-auto w-[13.5rem] lg:flex lg:flex-row lg:gap-8             lg:opacity-0 lg:group-hover:visible lg:group-hover:opacity-100"
                >
                  <div class="lg:flex lg:flex-col lg:divide-y lg:justify-center lg:w-1/2">
                  {menu.children?.map((child) => (
                    <li class="nav-dropdown-item">
                      <a
                        href={getRelativeLocaleUrl(currentLocale ?? '', child.url)}
                        class={`py-2 lg:pt-3 lg:h-[85px] items-center nav-dropdown-link block ${
                          isActive(pathname, child.url, currentLocale ?? '') ? 'text-primary' : ''
                        }`}
                      >
                        <div class="text-center flex flex-row gap-2 lg:justify-start justify-center items-center ">
                          {t(`nav.${child.name.toLowerCase()}`)}
                          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 8.25 21 12m0 0-3.75 3.75M21 12H3" />
                          </svg>
                        </div>
                        <p class="hidden lg:mt-1 lg:text-gray-500 lg:inline-block">
                          Trending wallpapers for any kind of tatse
                        </p>
                      </a>
                    </li>
                  ))}
                  </div>
                  <div class="hidden lg:w-1/2 lg:h-full lg:inline-block">
                    <div class="bg-black lg:p-5 rounded-xl space-y-4 h-full flex flex-col justify-center ">
                      <div >
                        <p class="text-xl text-white tracking-tight text-balance">
Conoce más sobre nuestros <span class="text-gray-400">INCREIBLES PRODUCTOS</span> 
                        </p>
                      </div>
                      <a 
                        href={getRelativeLocaleUrl(currentLocale ?? '', `/products`)}
                        class={`nav-link items-center text-sm group active:bg-gray-100 active:text-gray-900/60 active:transition-none border font-medium flex flex-row justify-center gap-2 outline-offset-2 px-6 py-3 transition w-full bg-white hover:bg-gray-50 text-black rounded-lg ${
                          isActive(pathname, '/products', currentLocale ?? '') ? 'text-primary border-primary' : ''
                        }`}
                      >
                        <p>{t(`nav.${menu.name.toLowerCase()}`)}</p>
                        <span>
                          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 8.25 21 12m0 0-3.75 3.75M21 12H3" />
                          </svg>
                        </span> 
                      </a>
                    </div>
                  </div>
                </ul>
              </li>
            ) : (
              //Nav sin hijos
              <li class="nav-item">
                <a
                  href={getRelativeLocaleUrl(currentLocale ?? '', menu.url)}
                  class={`nav-link inline-block lg:block mx-4 ${
                    isActive(pathname, menu.url, currentLocale) ? "active" : ""
                  }`}
                >
                  {t(`nav.${menu.name.toLowerCase()}`)}
                </a>
              </li>
            )}
          </>
        ))
      }
      <!-- LanguageSelector and DarkMode button Mobile-->
      <li class="nav-item mt-4 lg:hidden flex flex-row items-center justify-center gap-4	">

        {!Astro.props.is404 && (
          <LanguageSelector />
        )}
        <ThemeToggle /> 
      </li>
    </ul>
    <!-- LanguageSelector and DarkMode button Full page-->
    <div
    class="order-1 ml-auto hidden items-center md:order-2 md:ml-0 lg:flex transition-transform duration-[600ms] ease-[cubic-bezier(0.4,0,0.2,1)] menu-container"
  >
      {!Astro.props.is404 && (
          <LanguageSelector />
        )}
        <ThemeToggle />
    </div>
    
  </nav>
</header>

<script> 
  //Se cambio <script is:inline> por solo <script>
  
  function button_2() {  
  const button = document.getElementById("dropdown-button");
  button.addEventListener("click", () => {
    const dropdown = document.getElementById("dropdown");
    dropdown.classList.toggle(dropdown.style === "hidden" ? "block" : "hidden");
  });
  }
  button_2()
  //sticky header

  function header_2() {  
  const header = document.querySelector(".header");
  window.addEventListener("scroll", () => {
    const scrollY = window.scrollY;
    if (scrollY > 0) {
      header.classList.add("header-sticky");
    } else {
      header.classList.remove("header-sticky");
    }
  });
  }
  header_2()

  document.addEventListener('astro:after-swap', button_2);
  document.addEventListener('astro:after-swap', header_2);
</script>


