---
// Parte del servidor (Astro)
import "photoswipe/style.css";
import productsES from '@data/es/products.json';
import productsEN from '@data/en/products.json';

const fallbackLocale = 'es';
const { currentLocale } = Astro

// Selecciona productos seg칰n el idioma
const allProducts = currentLocale === 'en' ? productsEN : productsES;

const { id_product } = Astro.props;

// Buscar el producto con ese ID
const product = allProducts.find(p => p.id_product === id_product);

if (!product) {
  throw new Error(`No se encontr칩 el producto con id_product=${id_product}`);
}

// Obtener las im치genes desde el JSON
const images = product.images || [];
const mainImage = images.find(img => img.isMain);
const galleryImages = images.filter(img => !img.isMain);
---

<div class="flex flex-col gap-y-6" id="galery">
  <div class="rounded-4xl">
    {mainImage && (
      <a 
        href={mainImage.src}
        data-pswp-width="400"
        data-pswp-height="400"
      >
        <img
          transition:name={`img-${id_product}`}
          src={mainImage.src}
          class="border border-black w-full h-full aspect-square object-contain rounded-xl"
          alt=""
        />
      </a>
    )}
  </div>
  <div class="rounded-1 flex flex-row gap-1 h-24">
    {galleryImages.map((image) => (
      <a
        href={image.src}
        data-pswp-width="400"
        data-pswp-height="400"
      >
        <img 
          src={image.src}
          class="border border-black w-24 h-24 rounded-md cursor-pointer object-contain"
          alt=""
        />
      </a>
    ))}
  </div>
</div>

<script>
  async function getImageSize(src) {
    return new Promise((resolve) => {
      const img = new Image();
      img.src = src;
      img.onload = () => {
        resolve({ width: img.naturalWidth, height: img.naturalHeight });
      };
    });
  }

  document.addEventListener("astro:page-load", async () => {
    const anchors = document.querySelectorAll("#galery a");

    for (const a of anchors) {
      const img = a.querySelector("img");
      if (img) {
        const { width, height } = await getImageSize(img.src);
        a.dataset.pswpWidth = width;
        a.dataset.pswpHeight = height;
      }
    }

    const { default: PhotoSwipeLightbox } = await import("photoswipe/lightbox");

    const lightbox = new PhotoSwipeLightbox({
      gallery: "#galery",
      children: "a",
      pswpModule: () => import("photoswipe"),
      //showHideAnimationType: 'zoom',
      showHideAnimationType: 'fade', // 游녤 se desvanece al cerrar
      showAnimationDuration: 300,    // (opcional) animaci칩n de apertura
      hideAnimationDuration: 200     // 游녣 duraci칩n de fade-out al cerrar
    });

    lightbox.init();
  });
</script>